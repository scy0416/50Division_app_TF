{% extends 'base.html' %}
{% block to_back %}
{{ url_for('admin_grievance.index') }}
{% endblock %}
{% block content %}
<style>
    textarea.readonly{width:100%;resize:none;border:none}
    textarea{resize:none}
    thead td{text-align:right;color:gray}
</style>
<div class="container my-3">
    <div class="d-flex flex-column" style="border-bottom:1px #dee2e6 solid">
        <table class="table table-sm">
            <tr>
                <th class="fs-4 my-3" colspan="2">{{ post.subject|safe }}</th>
            </tr>
            <tr class="text-end">
                <td colspan="2">게시자 : {{ user.name }}</td>
            </tr>
            <tr class="text-end">
                <td colspan="2">작성일 : {{ post.create_date|datetime }}</td>
            </tr>
            <tr>
                <th>직책</th>
                <td>{{ user.position }}</td>
            </tr>
            <tr>
                <th>부대명</th>
                <td>{{ user.unit_name }}</td>
            </tr>
        </table>
        <div class="container" id="content"></div>
    </div>
    <!-- 댓글 -->
    {% if comments|length > 0 %}
    <hr>
    <div class="mt-2">
        {% for comment in comments %}
        <div class="comment py-2" style="border-bottom:1px #dee2e6 solid;">
            {% if g.user.id == (comment|getUser).id %}
            <div style="color:black">{{ (comment|getUser).name }}</div>
            <div class="container sn" data-comment_id="{{ comment.id }}">
                {{ comment.content|safe }}
            </div>
            <span style="font-size:12px">
                {{ comment.create_date|datetime }}
                {% if comment.modify_date %}
                (수정됨)
                {% endif %}
            </span>
            <div class="text-end">
                <button class="btn btn-secondary btn-sm" onclick="edit(this)">수정</button>
                <button class="btn btn-secondary btn-sm" style="display:none"
                        onclick="save(this)">저장</button>
                <button class="btn btn-secondary btn-sm" onclick="delete_comment(this)">삭제</button>
                <form method="post" action="{{ url_for('admin_grievance.delete_comment', comment_id=comment.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                </form>
            </div>
            {% else %}
            <div style="color:black">작성자-{{ (comment|getUser).name }}</div>
            <div class="container">{{ comment.content|safe }}</div>
            <span style="font-size:12px">
                {{ comment.create_date|datetime }}
                {% if comment.modify_date %}
                (수정됨)
                {% endif %}
            </span>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <hr>
    <!-- 댓글 작성 -->
    <div>
        <form method="post"
              action="{{ url_for('admin_grievance.create_comment', post_id=post.id) }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <textarea rows="1" class="summernote" style="resize:none" name="content"></textarea>
            <button class="btn btn-secondary btn-sm align-self-end">등록</button>
        </form>
    </div>
</div>
{% endblock %}
{% block script %}
<link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
<script>
    $(document).ready(function(){
        $(".summernote").summernote({
            toolbar:[],
            placeholder:'댓글작성'
        });
        $("#content").html(`{{ post.content|safe }}`);
    });
    function edit(El){
        var editBtn = $(El);
        var sn = editBtn.parent().siblings('.sn');
        var saveBtn = editBtn.next();
        editBtn.css('display', 'none');
        saveBtn.css('display', 'inline-block');
        sn.summernote({toolbar:[]});
    }
    function save(El){
        var saveBtn = $(El);
        var sn = saveBtn.parent().siblings('.sn');
        var editBtn = saveBtn.prev();
        var content = sn.summernote('code');
        saveBtn.css('display', 'none');
        editBtn.css('display', 'inline-block');
        sn.summernote('destroy');

        $.ajax({
            url: 'comment/' + sn.data('comment_id') + '/edit',
            type: 'POST',
            data: {
                content: content
            },
            beforeSend: function(xhr){
                xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token() }}');
            },
            success: function(){},
            error: function(jqXHR, textStatus, errorThrown){
                console.error("Error: " + textStatus + ", " + errorThrown);
            }
        });
    }
    function delete_comment(El){
        var deleteBtn = $(El);
        var comment_id = deleteBtn.siblings(".sn").data("comment_id");
        if(confirm("정말 삭제하시겠습니까?")){
            deleteBtn.next().submit();
        }
    }
</script>
{% endblock %}